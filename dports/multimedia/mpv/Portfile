# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:filetype=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem              1.0
PortGroup               compiler_blacklist_versions 1.0
PortGroup               github 1.0
PortGroup               waf 1.0

github.setup            mpv-player mpv 0.3.8 v
categories              multimedia
license                 GPL-2+
maintainers             ionic.de:ionic openmaintainer
platforms               darwin

description             mpv is a movie player based on MPlayer and mplayer2.
long_description        ${description} It plays most MPEG/VOB, AVI, Ogg/OGM, \
                        VIVO, ASF/WMA/WMV, QT/MOV/MP4, RealMedia, Matroska, \
                        NUT, NuppelVideo, FLI, YUV4MPEG, FILM, RoQ, PVA files, \
                        supported by many native, XAnim, and Win32 DLL codecs. \
                        You can watch VideoCD, SVCD, DVD, 3ivx, DivX 3/4/5, WMV \
                        and even H.264 movies.
homepage                http://www.mpv.io/

depends_build           path:bin/pkg-config:pkgconfig
depends_lib             path:lib/libavcodec.dylib:ffmpeg \
                        path:bin/perl:perl5 \
                        port:py32-docutils \
                        port:rst2pdf \
                        port:libiconv \
                        port:ncurses \
                        port:zlib \
                        port:libass \
                        port:libbluray \
                        port:libdvdread \
                        port:libdvdnav \
                        port:lcms2

checksums               rmd160  26e4ebe375402bceb1fcdf6dc5e0b346ca0b6b35 \
                        sha256  9fff6d665fcc44ea77e6c530e5d931dbf8c10f5a07783ffcbbc3df9ede5e7d2f

patchfiles              patch_py32-docutils.diff

universal_variant       no

default_variants        +bundle +network +osd +mp3 +opengl


# Default configuration options. Mostly Mac OS X specific.
configure.args-append   --enable-libass \
                        --enable-coreaudio \
                        --enable-cocoa \
                        --enable-corevideo \
                        --disable-vda-hwaccel \
                        --disable-vda-gl

# mpv autodetects many support libs.  To prevent undeclared
# dependencies, explicitly disable everything optional first.
# This list should be expanded each time the port is updated to a
# new version, disabling any newly added options.
configure.args-append   --disable-macosx-bundle \
                        --disable-debug-build \
                        --disable-libsmbclient \
                        --disable-libass-osd \
                        --disable-libquvi \
                        --disable-lirc \
                        --disable-cdda \
                        --disable-enca \
                        --disable-mpg123 \
                        --disable-pulse \
                        --disable-portaudio \
                        --disable-jack \
                        --disable-openal \
                        --disable-gl-cocoa \
                        --disable-x11 \
                        --disable-xss \
                        --disable-xext \
                        --disable-xv \
                        --disable-gl-x11 \
                        --disable-xinerama \
                        --disable-xf86vm \
                        --disable-xf86xk \
                        --disable-caca \
                        --disable-jpeg \
                        --disable-tv \
                        --disable-lua

# Fix picking up the correct talloc version.
configure.cppflags -I${worksrcpath} ${configure.cppflags}

platform darwin {
    # FIXME: use ${os.minor} once it hits stable base
    # VDA (video hardware acceleration, mostly H264) is only supported on 10.6.3+
    if {${os.major} > 10 || {${os.major} == 10 && [lindex [split ${os.version} .] 1] >= 3}} {
        configure.args-delete   --disable-vda-hwaccel \
                                --disable-vda-gl
        configure.args-append   --enable-vda-hwaccel \
                                --enable-vda-gl
    }
}

pre-configure {
    system -W "${worksrcpath}" "${waf.python} bootstrap.py"
}

post-destroot {
    xinstall -d -m 0755 ${destroot}${prefix}/etc/${name}
    foreach etcfile {encoding-profiles.conf example.conf input.conf} {
        xinstall -m 0644 ${worksrcpath}/etc/${etcfile} \
            ${destroot}${prefix}/etc/${name}/${etcfile}
    }
    xinstall -d -m 0755 ${destroot}${prefix}/share/man/man1
    xinstall -m 0644 ${worksrcpath}/build/DOCS/man/en/mpv.1 \
        ${destroot}${prefix}/share/man/man1/
    xinstall -d -m 0755 ${destroot}${prefix}/share/examples/${name}
    eval file copy [glob ${worksrcpath}/TOOLS/*.lua ${worksrcpath}/TOOLS/*.pl \
                         ${worksrcpath}/TOOLS/*.sh ${worksrcpath}/TOOLS/*.py \
                         ${worksrcpath}/TOOLS/umpv] \
                   ${destroot}${prefix}/share/examples/${name}

    if {[variant_isset bundle]} {
        xinstall -d -m 0755 ${destroot}${applications_dir}
        file rename ${destroot}${prefix}/bin/mpv.app ${destroot}${applications_dir}
    }
}


# When enabling features, make sure to replace the "disable" flags with
# "enable" flags in order to make the waf build system error out in case
# a feature cannot be used/found. Problems like that indicate a missing
# runtime dependency.
# libquvi is a special case. We just add libquvi-scripts as a dependency
# and hope for waf to autodetect this version. Do not explicitly enable
# libquvi, as mpv supports multiple versions and we don't want waf to
# throw an error if some other version wasn't found.

variant bundle description {Enable the optional Mac OS X bundle of mpv} {
    configure.args-replace  --disable-macosx-bundle \
                            --enable-macosx-bundle
}

variant screenshot description {Enable optional screenshot support} {
    depends_lib-append      port:jpeg
    configure.args-replace  --disable-jpeg \
                            --enable-jpeg
}

variant network description {Enable networking support via libquvi-scripts} {
    depends_lib-append      port:libquvi-scripts
    configure.args-delete   --disable-libquvi
}

variant lirc description {Enable Linux Infrared Remote Daemon support} {
    depends_lib-append      port:lirc
    configure.args-replace  --disable-lirc \
                            --enable-lirc
}

variant nodvd description {Disable DVD and DeCSS support} {
    depends_lib-delete      port:libdvdread \
                            port:libdvdnav
    configure.args-append   --disable-dvdread --disable-dvdnav
}

variant audiocd description {Enable Audio CD support via libcdio-paranoia (currently unsupported!)} {
    #depends_lib-append      port:libcdio-paranoia
    #configure.args-replace   --disable-cdda \
                              --enable-cdda
    ui_error "Audio CD support is currently disabled due to a missing libcdio-paranoia port."
    error "audiocd variant not supported"
}

variant enca description {Enable encoding support via ENCA} {
    depends_lib-append      port:enca
    configure.args-replace  --disable-enca \
                            --enable-enca
}

variant mp3 description {Enable mp3 support via mpg123} {
    depends_lib-append      port:mpg123
    configure.args-replace  --disable-mpg123 \
                            --enable-mpg123
}

variant pulseaudio description {Enable PulseAudio support} {
    depends_lib-append      port:pulseaudio
    configure.args-replace  --disable-pulse \
                            --enable-pulse
}

variant portaudio description {Enable portaudio support} {
    depends_lib-append      port:portaudio
    configure.args-replace  --disable-portaudio \
                            --enable-portaudio
}

variant jack description {Enable Jack Audio Connection Kit support} {
    depends_lib-append      port:jack
    configure.args-replace  --disable-jack \
                            --enable-jack
}

# TODO: switch that to openal-soft? Leave it as-is?
variant openal description {Enable OpenAL support} {
    depends_lib-append      port:openal
    configure.args-replace  --disable-openal \
                            --enable-openal
}

variant x11 {
    depends_lib-append      port:xorg-libXext \
                            port:xorg-libXScrnSaver \
                            port:xorg-libXinerama \
                            port:xorg-libXv \
                            port:xorg-libXxf86vm

    configure.args-delete   --disable-x11 \
                            --disable-xss \
                            --disable-xext \
                            --disable-xinerama \
                            --disable-xv \
                            --disable-xf86vm
    configure.args-append   --enable-x11 \
                            --enable-xss \
                            --enable-xext \
                            --enable-xv \
                            --enable-xinerama \
                            --enable-xf86vm
}

variant opengl description {Enable glx output support.  Both the CoreVideo and X11 outputs are supported} {
    configure.args-replace  --disable-gl-cocoa \
                            --enable-gl-cocoa

    if {[variant_isset x11]} {
        depends_lib-append      port:mesa
        configure.args-replace  --disable-gl-x11 \
                                --enable-gl-x11
    }
}

variant caca description {Enable animated ASCII art video output} {
    depends_lib-append      port:libcaca
    configure.args-replace  --disable-caca \
                            --enable-caca
}

variant osd description {Enable onscreen display and TrueType font support} {
    depends_lib-append      port:lua
    configure.args-delete   --disable-lua \
                            --disable-libass-osd
    configure.args-append   --enable-lua \
                            --enable-libass-osd
}

variant smb description {Enable Samba support} {
    depends_lib-append      path:lib/pkgconfig/smbclient.pc:samba3
    configure.args-replace  --disable-libsmbclient \
                            --enable-libsmbclient
}

variant debug description {Compile with debugging symbols} {
    configure.args-replace  --disable-debug-build \
                            --enable-debug-build
}
